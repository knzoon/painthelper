package org.knzoon.painthelper.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.Test;
import org.knzoon.painthelper.representation.warded.UniqueWardedZones;

import static org.assertj.core.api.Assertions.assertThat;

class WardedRegionDataParserTest {
    private final static String DATA_START_SEARCHPATTERN = "\"type\":\"FeatureCollection\"";

    private final static String LINE_CONTAINING_DATA = "                    data: {\"type\":\"FeatureCollection\",\"features\":[{\"type\":\"Feature\",\"geometry\":{\"type\":\"Point\",\"coordinates\":[18.702778,64.598033]},\"properties\":{\"title\":\"Norrmalmzon\",\"count\":1,\"zone_type\":null}}]}";

    private final static String NEW_LINE_CONTAINING_DATA = "window.MapConfig = {\"type\":\"unique\",\"data\":{\"sources\":{\"unique\":{\"type\":\"geojson\",\"data\":{\"type\":\"FeatureCollection\",\"features\":[{\"type\":\"Feature\",\"geometry\":{\"type\":\"Point\",\"coordinates\":[18.702778,64.598033]},\"properties\":{\"title\":\"Norrmalmzon\",\"count\":1}},{\"type\":\"Feature\",\"geometry\":{\"type\":\"Point\",\"coordinates\":[20.300605,63.807757]},\"properties\":{\"title\":\"SophieHome\",\"count\":2539}}]}},\"untaken\":{\"type\":\"geojson\",\"data\":{\"type\":\"FeatureCollection\",\"features\":[]}}},\"region\":0,\"round\":null,\"regions\":[{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"127\",\"REGION_NAME\":\"V\\u00e4sterbotten\",\"REGION_TOTAL_ZONE_COUNT\":\"2187\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"129\",\"REGION_NAME\":\"Dalarna\",\"REGION_TOTAL_ZONE_COUNT\":\"2519\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"131\",\"REGION_NAME\":\"\\u00d6rebro\",\"REGION_TOTAL_ZONE_COUNT\":\"2142\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"132\",\"REGION_NAME\":\"V\\u00e4stra G\\u00f6taland\",\"REGION_TOTAL_ZONE_COUNT\":\"7813\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"139\",\"REGION_NAME\":\"\\u00d6sterg\\u00f6tland\",\"REGION_TOTAL_ZONE_COUNT\":\"2298\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"141\",\"REGION_NAME\":\"Stockholm\",\"REGION_TOTAL_ZONE_COUNT\":\"7082\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"142\",\"REGION_NAME\":\"Uppsala\",\"REGION_TOTAL_ZONE_COUNT\":\"2135\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"143\",\"REGION_NAME\":\"V\\u00e4stmanland\",\"REGION_TOTAL_ZONE_COUNT\":\"2025\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"144\",\"REGION_NAME\":\"G\\u00e4vleborg\",\"REGION_TOTAL_ZONE_COUNT\":\"1882\"},{\"COUNTRY_ID\":\"1\",\"REGION_ID\":\"145\",\"REGION_NAME\":\"V\\u00e4sternorrland\",\"REGION_TOTAL_ZONE_COUNT\":\"1481\"},{\"COUNTRY_ID\":\"4\",\"REGION_ID\":\"211\",\"REGION_NAME\":\"Spain\",\"REGION_TOTAL_ZONE_COUNT\":\"372\"},{\"COUNTRY_ID\":\"4\",\"REGION_ID\":\"216\",\"REGION_NAME\":\"Czech Republic\",\"REGION_TOTAL_ZONE_COUNT\":\"58\"},{\"COUNTRY_ID\":\"4\",\"REGION_ID\":\"220\",\"REGION_NAME\":\"Thailand\",\"REGION_TOTAL_ZONE_COUNT\":\"149\"},{\"COUNTRY_ID\":\"8\",\"REGION_ID\":\"186\",\"REGION_NAME\":\"L\\u00e4nsi- ja Sis\\u00e4-Suomi\",\"REGION_TOTAL_ZONE_COUNT\":\"510\"}],\"rounds\":[{\"GAME_ROUND_ID\":\"181\"},{\"GAME_ROUND_ID\":\"180\"},{\"GAME_ROUND_ID\":\"179\"},{\"GAME_ROUND_ID\":\"178\"},{\"GAME_ROUND_ID\":\"177\"},{\"GAME_ROUND_ID\":\"176\"},{\"GAME_ROUND_ID\":\"175\"},{\"GAME_ROUND_ID\":\"174\"},{\"GAME_ROUND_ID\":\"173\"},{\"GAME_ROUND_ID\":\"172\"},{\"GAME_ROUND_ID\":\"171\"},{\"GAME_ROUND_ID\":\"170\"},{\"GAME_ROUND_ID\":\"169\"},{\"GAME_ROUND_ID\":\"168\"},{\"GAME_ROUND_ID\":\"167\"},{\"GAME_ROUND_ID\":\"166\"},{\"GAME_ROUND_ID\":\"165\"},{\"GAME_ROUND_ID\":\"164\"},{\"GAME_ROUND_ID\":\"163\"},{\"GAME_ROUND_ID\":\"162\"},{\"GAME_ROUND_ID\":\"161\"},{\"GAME_ROUND_ID\":\"160\"},{\"GAME_ROUND_ID\":\"159\"},{\"GAME_ROUND_ID\":\"158\"},{\"GAME_ROUND_ID\":\"157\"},{\"GAME_ROUND_ID\":\"156\"},{\"GAME_ROUND_ID\":\"155\"},{\"GAME_ROUND_ID\":\"154\"},{\"GAME_ROUND_ID\":\"153\"},{\"GAME_ROUND_ID\":\"152\"},{\"GAME_ROUND_ID\":\"151\"},{\"GAME_ROUND_ID\":\"150\"},{\"GAME_ROUND_ID\":\"149\"},{\"GAME_ROUND_ID\":\"148\"},{\"GAME_ROUND_ID\":\"147\"},{\"GAME_ROUND_ID\":\"146\"},{\"GAME_ROUND_ID\":\"145\"},{\"GAME_ROUND_ID\":\"144\"},{\"GAME_ROUND_ID\":\"143\"},{\"GAME_ROUND_ID\":\"142\"},{\"GAME_ROUND_ID\":\"141\"},{\"GAME_ROUND_ID\":\"140\"},{\"GAME_ROUND_ID\":\"139\"},{\"GAME_ROUND_ID\":\"138\"},{\"GAME_ROUND_ID\":\"137\"},{\"GAME_ROUND_ID\":\"136\"},{\"GAME_ROUND_ID\":\"135\"},{\"GAME_ROUND_ID\":\"134\"},{\"GAME_ROUND_ID\":\"133\"},{\"GAME_ROUND_ID\":\"132\"},{\"GAME_ROUND_ID\":\"131\"},{\"GAME_ROUND_ID\":\"130\"},{\"GAME_ROUND_ID\":\"129\"},{\"GAME_ROUND_ID\":\"128\"},{\"GAME_ROUND_ID\":\"127\"},{\"GAME_ROUND_ID\":\"126\"},{\"GAME_ROUND_ID\":\"125\"},{\"GAME_ROUND_ID\":\"124\"},{\"GAME_ROUND_ID\":\"123\"},{\"GAME_ROUND_ID\":\"122\"},{\"GAME_ROUND_ID\":\"121\"},{\"GAME_ROUND_ID\":\"120\"},{\"GAME_ROUND_ID\":\"119\"},{\"GAME_ROUND_ID\":\"118\"},{\"GAME_ROUND_ID\":\"117\"},{\"GAME_ROUND_ID\":\"116\"},{\"GAME_ROUND_ID\":\"115\"},{\"GAME_ROUND_ID\":\"114\"},{\"GAME_ROUND_ID\":\"113\"},{\"GAME_ROUND_ID\":\"112\"},{\"GAME_ROUND_ID\":\"111\"},{\"GAME_ROUND_ID\":\"110\"},{\"GAME_ROUND_ID\":\"109\"},{\"GAME_ROUND_ID\":\"108\"},{\"GAME_ROUND_ID\":\"107\"},{\"GAME_ROUND_ID\":\"106\"},{\"GAME_ROUND_ID\":\"105\"},{\"GAME_ROUND_ID\":\"104\"},{\"GAME_ROUND_ID\":\"103\"},{\"GAME_ROUND_ID\":\"102\"},{\"GAME_ROUND_ID\":\"101\"},{\"GAME_ROUND_ID\":\"100\"},{\"GAME_ROUND_ID\":\"99\"},{\"GAME_ROUND_ID\":\"98\"},{\"GAME_ROUND_ID\":\"97\"},{\"GAME_ROUND_ID\":\"96\"},{\"GAME_ROUND_ID\":\"95\"},{\"GAME_ROUND_ID\":\"94\"},{\"GAME_ROUND_ID\":\"93\"},{\"GAME_ROUND_ID\":\"92\"},{\"GAME_ROUND_ID\":\"91\"},{\"GAME_ROUND_ID\":\"90\"},{\"GAME_ROUND_ID\":\"89\"},{\"GAME_ROUND_ID\":\"88\"},{\"GAME_ROUND_ID\":\"87\"},{\"GAME_ROUND_ID\":\"86\"},{\"GAME_ROUND_ID\":\"85\"},{\"GAME_ROUND_ID\":\"84\"},{\"GAME_ROUND_ID\":\"83\"},{\"GAME_ROUND_ID\":\"82\"},{\"GAME_ROUND_ID\":\"81\"},{\"GAME_ROUND_ID\":\"80\"},{\"GAME_ROUND_ID\":\"79\"},{\"GAME_ROUND_ID\":\"78\"},{\"GAME_ROUND_ID\":\"77\"},{\"GAME_ROUND_ID\":\"76\"},{\"GAME_ROUND_ID\":\"75\"},{\"GAME_ROUND_ID\":\"74\"},{\"GAME_ROUND_ID\":\"73\"},{\"GAME_ROUND_ID\":\"72\"},{\"GAME_ROUND_ID\":\"71\"},{\"GAME_ROUND_ID\":\"70\"},{\"GAME_ROUND_ID\":\"69\"},{\"GAME_ROUND_ID\":\"68\"},{\"GAME_ROUND_ID\":\"67\"},{\"GAME_ROUND_ID\":\"66\"},{\"GAME_ROUND_ID\":\"65\"},{\"GAME_ROUND_ID\":\"64\"},{\"GAME_ROUND_ID\":\"63\"},{\"GAME_ROUND_ID\":\"62\"},{\"GAME_ROUND_ID\":\"61\"},{\"GAME_ROUND_ID\":\"60\"},{\"GAME_ROUND_ID\":\"59\"},{\"GAME_ROUND_ID\":\"58\"},{\"GAME_ROUND_ID\":\"57\"},{\"GAME_ROUND_ID\":\"56\"},{\"GAME_ROUND_ID\":\"55\"},{\"GAME_ROUND_ID\":\"54\"},{\"GAME_ROUND_ID\":\"53\"},{\"GAME_ROUND_ID\":\"52\"},{\"GAME_ROUND_ID\":\"51\"},{\"GAME_ROUND_ID\":\"50\"},{\"GAME_ROUND_ID\":\"49\"},{\"GAME_ROUND_ID\":\"48\"},{\"GAME_ROUND_ID\":\"47\"},{\"GAME_ROUND_ID\":\"46\"},{\"GAME_ROUND_ID\":\"45\"},{\"GAME_ROUND_ID\":\"44\"},{\"GAME_ROUND_ID\":\"43\"},{\"GAME_ROUND_ID\":\"42\"},{\"GAME_ROUND_ID\":\"41\"},{\"GAME_ROUND_ID\":\"40\"},{\"GAME_ROUND_ID\":\"39\"},{\"GAME_ROUND_ID\":\"38\"},{\"GAME_ROUND_ID\":\"37\"},{\"GAME_ROUND_ID\":\"36\"},{\"GAME_ROUND_ID\":\"35\"},{\"GAME_ROUND_ID\":\"34\"},{\"GAME_ROUND_ID\":\"33\"},{\"GAME_ROUND_ID\":\"32\"},{\"GAME_ROUND_ID\":\"31\"},{\"GAME_ROUND_ID\":\"30\"},{\"GAME_ROUND_ID\":\"29\"},{\"GAME_ROUND_ID\":\"28\"},{\"GAME_ROUND_ID\":\"27\"},{\"GAME_ROUND_ID\":\"26\"},{\"GAME_ROUND_ID\":\"25\"},{\"GAME_ROUND_ID\":\"24\"},{\"GAME_ROUND_ID\":\"23\"},{\"GAME_ROUND_ID\":\"22\"},{\"GAME_ROUND_ID\":\"21\"},{\"GAME_ROUND_ID\":\"20\"},{\"GAME_ROUND_ID\":\"19\"},{\"GAME_ROUND_ID\":\"18\"},{\"GAME_ROUND_ID\":\"17\"},{\"GAME_ROUND_ID\":\"16\"},{\"GAME_ROUND_ID\":\"15\"},{\"GAME_ROUND_ID\":\"14\"},{\"GAME_ROUND_ID\":\"13\"},{\"GAME_ROUND_ID\":\"12\"},{\"GAME_ROUND_ID\":\"11\"},{\"GAME_ROUND_ID\":\"10\"},{\"GAME_ROUND_ID\":\"9\"},{\"GAME_ROUND_ID\":\"8\"},{\"GAME_ROUND_ID\":\"7\"},{\"GAME_ROUND_ID\":\"6\"},{\"GAME_ROUND_ID\":\"5\"},{\"GAME_ROUND_ID\":\"4\"},{\"GAME_ROUND_ID\":\"3\"},{\"GAME_ROUND_ID\":\"2\"},{\"GAME_ROUND_ID\":\"1\"}]},\"controls\":[{\"type\":\"StyleSelector\",\"position\":\"top-right\",\"config\":{\"styles\":[\"dark\",\"bright\",\"satellite\"]}},{\"type\":\"CharacterPositionControl\",\"position\":\"top-right\",\"config\":[]},{\"type\":\"FilterPanel\",\"position\":\"top-left\",\"config\":{\"filters\":{\"zone_type\":{\"label\":\"Zone Type\",\"dynamic\":true}}}},{\"type\":\"ToggleControl\",\"position\":\"top-left\",\"config\":{\"buttons\":[{\"id\":\"unique\",\"label\":\"\",\"icon\":\"unique\",\"active\":true},{\"id\":\"untaken\",\"label\":\"\",\"icon\":\"untaken\",\"active\":false}]}},{\"type\":\"ZoneCountControl\",\"position\":\"bottom-right\",\"config\":{\"showTable\":true,\"showColoredTable\":true}}],\"layers\":[{\"id\":\"unique-zones\",\"type\":\"circle\",\"source\":\"unique\",\"paint\":{\"circle-color\":{\"property\":\"count\",\"type\":\"interval\",\"stops\":[[1,\"#00cc00\"],[2,\"#ffff00\"],[11,\"#ef8610\"],[21,\"#ff0000\"],[51,\"#cc00cc\"]]},\"circle-radius\":{\"base\":2,\"stops\":[[6,4],[9,4],[11,10],[12,12],[16,24]]},\"circle-blur\":0.2},\"layout\":{\"visibility\":\"visible\"}},{\"id\":\"unique-labels\",\"type\":\"symbol\",\"source\":\"unique\",\"layout\":{\"text-field\":[\"get\",\"count\"],\"text-font\":[\"Arial Unicode MS Regular\"],\"text-size\":{\"base\":4,\"stops\":[[9,6],[11,11],[16,18]]},\"text-anchor\":\"center\",\"text-allow-overlap\":true,\"visibility\":\"visible\"},\"minzoom\":11,\"filter\":[\"!=\",[\"get\",\"count\"],0]},{\"id\":\"untaken-zones\",\"type\":\"symbol\",\"source\":\"untaken\",\"layout\":{\"visibility\":\"none\",\"icon-image\":\"zoner\",\"icon-size\":1,\"icon-allow-overlap\":true}}],\"eventHandlers\":[{\"event\":\"toggle:changed\",\"handler\":\"handleToggleChange\"},{\"event\":\"filter:changed\",\"handler\":\"handleFilterChange\"}],\"config\":{\"mapbox\":{\"accessToken\":\"pk.eyJ1IjoiZWRkeXVldWUiLCJhIjoiY2o0Ym1paXdrMGRqaDJ3bGdqNHVoNmt1biJ9.8IHk71q107-GvxQisu4kZA\",\"styles\":{\"dark\":\"https:\\/\\/warded.se\\/turf\\/style-dg.json\",\"bright\":\"https:\\/\\/warded.se\\/turf\\/style-carto.json\",\"satellite\":\"https:\\/\\/warded.se\\/turf\\/style-arcgis.json\"},\"fonts\":{\"dark\":[\"Ubuntu Light Bold\",\"Arial Unicode MS Regular\"],\"bright\":[\"Open Sans Regular\",\"Arial Unicode MS Regular\"],\"satellite\":[\"Noto Sans Regular\",\"Arial Unicode MS Regular\"]}},\"defaults\":{\"zoom\":10,\"center\":[18,59],\"style\":\"dark\"},\"api\":{\"endpoints\":{\"zones\":\"\\/turf\\/maps\\/api\\/zones\",\"users\":\"\\/turf\\/maps\\/api\\/users\",\"proxy\":\"\\/turf\\/maps\\/api\\/proxy\"},\"cache\":{\"ttl\":300,\"enabled\":true}},\"controls\":{\"positions\":{\"navigation\":\"top-right\",\"fullscreen\":\"top-right\",\"style\":\"top-right\",\"filter\":\"top-left\",\"toggle\":\"top-left\",\"counts\":\"bottom-right\"},\"showZoneCount\":true,\"showFilters\":true,\"showToggle\":true},\"performance\":{\"maxFeatures\":10000,\"clusterThreshold\":500,\"debounceDelay\":300},\"name\":\"Unique Zones\",\"description\":\"Shows zones that you have taken\",\"defaultStyle\":\"dark\",\"colors\":{\"unique\":\"#00ff00\",\"untaken\":\"#ff0000\"},\"layers\":{\"unique\":{\"visible\":true,\"minZoom\":5,\"maxZoom\":20},\"untaken\":{\"visible\":false,\"minZoom\":5,\"maxZoom\":20}}},\"params\":{\"type\":\"unique\",\"region\":0,\"round\":null},\"auth\":{\"user_id\":\"64871\",\"game_id\":\"181\",\"authenticated\":true},\"defaultStyle\":\"dark\",\"boundsBehavior\":\"fit_bounds\",\"userPosition\":{\"lat\":\"63.808766\",\"lon\":\"20.300858\"}};";

    @Test
    public void testArne() {
        final String REGION_SEARCHPATTERN = "<option selected=\"\" value=\"";

        String apaEtt = "<option value=\"0\">Global</option>";
        String apaTvå = "<option value=\"144\">Gävleborg</option><option value=\"141\">Stockholm</option><option value=\"142\">Uppsala</option><option SELECTED=\"\" value=\"127\">Västerbotten</option><option value=\"145\">Västernorrland</option><option value=\"143\">Västmanland</option><option value=\"132\">Västra Götaland</option><option value=\"131\">Örebro</option><option value=\"216\">Czech Republic</option><option value=\"211\">Spain</option><option value=\"220\">Thailand</option><option value=\"186\">Länsi- ja Sisä-Suomi</option></select>";
        String apaTre = "    });";

        int iDidntFind = apaEtt.toLowerCase().lastIndexOf(REGION_SEARCHPATTERN);
        int iFound = apaTvå.toLowerCase().lastIndexOf(REGION_SEARCHPATTERN);
        String idAndTheRest = apaTvå.substring(iFound + REGION_SEARCHPATTERN.length());
        int iOfClosingFnutt = idAndTheRest.indexOf("\"");
        String idValue = idAndTheRest.substring(0, iOfClosingFnutt);
        assertThat(idValue).isEqualTo("127");
        int iOfStartOfOption = idAndTheRest.indexOf("<");
        String regionName = idAndTheRest.substring(iOfClosingFnutt + 2, iOfStartOfOption);
        assertThat(regionName).isEqualTo("Västerbotten");

        iFound = apaTre.indexOf("});");
        String endOfData = apaTre.substring(0, iFound + 1);
        assertThat(endOfData).isEqualTo("    }");
    }

    @Test
    public void canParseUsername() {
        WardedRegionDataParser parser = new WardedRegionDataParser();
        String username = parser.parseUsername(8, "        <button class=\"dropbtn\">praktikus            <i class=\"dropbtnarrow\"></i>");
        assertThat(username).isEqualTo("praktikus");
    }

    @Test
    public void canFindStartOfDataAndIsolateData() {

        int searchpatternFoundAtIndex = LINE_CONTAINING_DATA.indexOf(DATA_START_SEARCHPATTERN);
        assertThat(searchpatternFoundAtIndex).isPositive();

    }

    @Test
    public void canParseDataAndConvertFromJson() throws Exception{
        WardedRegionDataParser parser = new WardedRegionDataParser();
        String jsonData = parser.parseActualData(NEW_LINE_CONTAINING_DATA);
        ObjectMapper objectMapper = new ObjectMapper();
        UniqueWardedZones uniqueWardedZones = objectMapper.readValue(jsonData, UniqueWardedZones.class);

        assertThat(uniqueWardedZones).isNotNull();
    }

}